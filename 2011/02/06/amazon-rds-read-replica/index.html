
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>Amazon RDS の Read Replica 触ってみた  | Hiro Fukami's Blog</title>

<meta name="author" content="HiroFukami"> 

<meta name="description" content="前から気になっていた Amazon RDS を触ってみた。gumiは自前でインスタンスにMySQLをセットアップせずにRDS使っているし、read replicaも出てスケーリングに関してどの程度カバーできるのか興味もあった。やっぱりMySQLの構築や運用は任せられたほうが楽なので。 &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hiro Fukami's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/favicon.png" rel="shortcut icon">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- <script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>
 -->
	
	<meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="d_sea">
    <meta property="twitter:url" content="http://hirofukami.com">
    <meta property="twitter:title" content="Amazon RDS の Read Replica 触ってみた">
    <meta property="twitter:description" content="前から気になっていた Amazon RDS を触ってみた。gumiは自前でインスタンスにMySQLをセットアップせずにRDS使っているし、read replicaも出てスケーリングに関してどの程度カバーできるのか興味もあった。やっぱりMySQLの構築や運用は任せられたほうが楽なので。 作り方はとても簡単。AWS Management &hellip;">
    <meta property="twitter:creator" content="d_sea" />


</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Hiro Fukami's Blog</a></h1>
<h4>My Life Log on Octopress</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
    
	<li>
        <form action="http://google.com/search" method="get">
            <input type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="as_sitesearch" value="hirofukami.com">
        </form>
	</li>
    
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
    
	<li>
        <form action="http://google.com/search" method="get">
            <input type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="as_sitesearch" value="hirofukami.com">
        </form>
	</li>
    
</ul>
</div>
	</div>
<!-- 	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:hirofukami.com">
			</form>
		</div>
	</div> -->
</nav>

</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Amazon RDS の Read Replica 触ってみた</h2>
	<div class="entry-content"><div class="section">
  <p>
    前から気になっていた Amazon RDS を触ってみた。gumiは自前でインスタンスにMySQLをセットアップせずに<a href="http://aws.amazon.com/jp/solutions/case-studies/gumi/" target="_blank">RDS使っている</a>し、read replicaも出てスケーリングに関してどの程度カバーできるのか興味もあった。やっぱりMySQLの構築や運用は任せられたほうが楽なので。
  </p>
  
  <p>
    <a href="http://f.hatena.ne.jp/d_sea/20110207182011" class="hatena-fotolife" target="_blank"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/d_sea/20110207/20110207182011.png?w=350" alt="f:id:d_sea:20110207182011p:image:w350" title="f:id:d_sea:20110207182011p:image:w350" class="hatena-fotolife" data-recalc-dims="1" /></a>
  </p>
  
  <p>
    作り方はとても簡単。AWS Management Console上ではいくつかのパラメータをいれてクリックしていければ作れる。最初にインスタンスタイプとストレージ容量などを決める必要があるが、これは後から変更も可能。
  </p>
  
  <p>
    ここで特徴的なのは Multi-AZ だと思う。これはおそらくレプリケーションしていて、Masterとは異なるAvailability Zoneにあるインスタンスでホットスタンバイ機が設けられる。万が一、Masterのデータセンターごと落ちちゃった時やメンテナンス時にこのスタンバイ機にフェールオーバーされるらしい。やはりDBはシングルポイントで落ちては困るので、Multi-AZ は付けておきたいが、<a href="http://aws.amazon.com/jp/rds/#pricing" target="_blank">料金も倍かかる</a>ので注意。
  </p>
  
  <p>
    <a href="http://f.hatena.ne.jp/d_sea/20110207182013" class="hatena-fotolife" target="_blank"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/d_sea/20110207/20110207182013.png?w=350" alt="f:id:d_sea:20110207182013p:image:w350" title="f:id:d_sea:20110207182013p:image:w350" class="hatena-fotolife" data-recalc-dims="1" /></a>
  </p>
  
  <p>
    変更画面はこんな感じでいろいろ変えることができる。インスタンスタイプとストレージ容量が途中で変えられるのは、予測しづらい中で運用する際には嬉しいと思う。
  </p>
  
  <p>
    最初のMasterの起動自体は5分くらいかかっている。裏でEBSマウントして、MySQL立ち上げてユーザ設定してとかやっているのだろう。
  </p>
  
  <p>
    <a href="http://f.hatena.ne.jp/d_sea/20110207182014" class="hatena-fotolife" target="_blank"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/d_sea/20110207/20110207182014.png?w=350" alt="f:id:d_sea:20110207182014p:image:w350" title="f:id:d_sea:20110207182014p:image:w350" class="hatena-fotolife" data-recalc-dims="1" /></a>
  </p>
  
  <p>
    Slaveにあたる read replica を作るのもAWS Management Consoleから行える。Masterより設定項目が少ないので、簡単にレプリケーションを張ったSlaveが作れる。read replica は最大5台まで立ち上げられる。
  </p>
  
  <p>
    <a href="http://f.hatena.ne.jp/d_sea/20110207191957" class="hatena-fotolife" target="_blank"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/d/d_sea/20110207/20110207191957.png?w=830" alt="f:id:d_sea:20110207191957p:image" title="f:id:d_sea:20110207191957p:image" class="hatena-fotolife" data-recalc-dims="1" /></a>
  </p>
  
  <p>
    read replica が立ち上げ中の時はManagement Console上のMasterのstatusはmodifyingになるので、レプリケーションをはるためにMySQLは止まってしまうのだろう。上は新規で立ち上げた read replica のstatus。
  </p>
  
  <p>
    ここから色々探ってみる。
  </p>
  
  <p>
    <a name="seemore"></a>
  </p>
  
  <p>
    ホスト名を引くとec2のホスト名にCNAMEされていた。
  </p>
  
  <pre>

$ host testidentifier.cstgtbgikb7y.us-east-1.rds.amazonaws.com

testidentifier.cstgtbgikb7y.us-east-1.rds.amazonaws.com is an alias for ec2-184-73-82-152.compute-1.amazonaws.com.

ec2-184-73-82-152.compute-1.amazonaws.com has address 184.73.82.152

</pre>
  
  <p>
    内部的にはEC2のインスタンスを起動、EBSマウント、レプリケーションをはる動作を行なっているようだ。起動スクリプトやれないことはないけれども、手間なのでワンクリックだけですむのは非常に楽に構築できる。ちなみに Snapshotもクリックひとつで簡単に取れる。
  </p>
  
  <p>
    Masterにmysqlログインして見てみる。
  </p>
  
  <pre>

dsea-MacBook:~ hironobu$ mysql -u testrep -p**** -h testidentifier.cstgtbgikb7y.us-east-1.rds.amazonaws.com



(snip)



mysql&gt; show databases;

+--------------------+

| Database           |

+--------------------+

| information_schema |

| innodb             |

| mysql              |

| testrds          |

+--------------------+

4 rows in set (0.18 sec)

</pre>
  
  <p>
    testrdsは自分が作ったDB。
  </p>
  
  <pre>

mysql&gt; select user,host from mysql.user;

+--------------+-----------+

| user         | host      |

+--------------+-----------+

| rdsrepladmin | %         |

| testrep      | %         |

| rdsadmin     | localhost |

+--------------+-----------+

3 rows in set (0.19 sec)



mysql&gt; show grants for rdsadmin@localhostG

*************************** 1. row ***************************

Grants for rdsadmin@localhost: GRANT ALL PRIVILEGES ON *.* TO 'rdsadmin'@'localhost' IDENTIFIED BY PASSWORD '*403D726C7C5F4E71D5790A7C0BCEA79CE3BEB17C' WITH GRANT OPTION

1 row in set (0.20 sec)



mysql&gt; show grants for rdsrepladminG

*************************** 1. row ***************************

Grants for rdsrepladmin@%: GRANT REPLICATION SLAVE ON *.* TO 'rdsrepladmin'@'%' IDENTIFIED BY PASSWORD '*132499B6DBF70C249F6262DB94789088E3B76B92'

1 row in set (0.20 sec)



mysql&gt; show grants for testrepG

*************************** 1. row ***************************

Grants for testrep@%: GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, PROCESS, REFERENCES, INDEX, ALTER, SHOW DATABASES, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER ON *.* TO 'testrep'@'%' IDENTIFIED BY PASSWORD '*39247272E1DEB1E4B93144EAB61B2F00A752CABC' WITH GRANT OPTION

1 row in set (0.20 sec)





</pre>
  
  <p>
    testrepは自分が起動時に設定したユーザなので、rdsrepladminとrdsadminというのがあらかじめ設定されてるユーザで、rootにあたるのがrdsadmin、read replicaからのレプリケーションを受け付けるためにrdsrepladminがあることが分かる。自分で作ったユーザには管理系のコマンドは実行できないようになっている。
  </p>
  
  <pre>

mysql&gt; show master status;

+----------------------------+----------+--------------+------------------+

| File                       | Position | Binlog_Do_DB | Binlog_Ignore_DB |

+----------------------------+----------+--------------+------------------+

| mysql-bin-changelog.000013 |      106 |              |                  |

+----------------------------+----------+--------------+------------------+

1 row in set (0.18 sec)

</pre>
  
  <p>
    確かにMasterとして動いている。
  </p>
  
  <p>
    次に read replicaにmysqlログインしてみる。
  </p>
  
  <pre>

$ mysql -u testrep -p**** -h replica01testidentifier.cstgtbgikb7y.us-east-1.rds.amazonaws.com



(snip)



mysql&gt; select user,host from mysql.user;

+--------------+-----------+

| user         | host      |

+--------------+-----------+

| rdsrepladmin | %         |

| testrep      | %         |

| rdsadmin     | localhost |

+--------------+-----------+

3 rows in set (0.19 sec)



mysql&gt; show databases;

+--------------------+

| Database           |

+--------------------+

| information_schema |

| innodb             |

| mysql              |

| testopenx          |

+--------------------+

</pre>
  
  <p>
    あたりまえだけどMasterと同じ。
  </p>
  
  <pre>

mysql&gt; show slave statusG

*************************** 1. row ***************************

Slave_IO_State: Waiting for master to send event

Master_Host: testidentifier.cstgtbgikb7y.us-east-1.rds.amazonaws.com

Master_User: rdsrepladmin

Master_Port: 3306

Connect_Retry: 60

Master_Log_File: mysql-bin-changelog.000013

Read_Master_Log_Pos: 106

Relay_Log_File: relaylog.000018

Relay_Log_Pos: 261

Relay_Master_Log_File: mysql-bin-changelog.000013

Slave_IO_Running: Yes

Slave_SQL_Running: Yes

Replicate_Do_DB:

Replicate_Ignore_DB:

Replicate_Do_Table:

Replicate_Ignore_Table:

Replicate_Wild_Do_Table:

Replicate_Wild_Ignore_Table:

Last_Errno: 0

Last_Error:

Skip_Counter: 0

Exec_Master_Log_Pos: 106

Relay_Log_Space: 462

Until_Condition: None

Until_Log_File:

Until_Log_Pos: 0

Master_SSL_Allowed: No

Master_SSL_CA_File:

Master_SSL_CA_Path:

Master_SSL_Cert:

Master_SSL_Cipher:

Master_SSL_Key:

Seconds_Behind_Master: 0

Master_SSL_Verify_Server_Cert: No

Last_IO_Errno: 0

Last_IO_Error:

Last_SQL_Errno: 0

Last_SQL_Error:

1 row in set (0.19 sec)

</pre>
  
  <p>
    Masterのホスト名宛にrdsrepladminユーザでレプリケーションがはれていることが分かる。
  </p>
  
  <p>
    中身を見てしまえば、MySQLのレプリケーションの構成。確かに簡単にレプリケーション環境をクリックだけで作れるのは新しい感覚。
  </p>
  
  <p>
    ここまで作れているのは嬉しいが、やっぱりEC2をベースにしているとはっきり分かるスタンスがユーザビリティに影響している部分がある。せっかく read replica で簡単に増やせても、その把握とクエリを投げる先に加える仕組みはユーザ側で用意しなければならないから、実運用上はサービスを止めてメンテナンスで更新をかけたり、クエリの分散先をスムーズに更新する自動化された仕組みを頑張って用意するのだろう。
  </p>
  
  <p>
    そこら辺を踏まえ、せっかくスケーラブルなベースが出来ているのだから、以下の機能も提供してもらえたら素晴らしくなるのにと思った。
  </p>
  
  <ul>
    <li>
      read replicaのオートスケーリングへの対応</p> <ul>
        <li>
          結局中身はEC2なのだし
        </li>
      </ul>
    </li>
    
    <li>
      増えた read replica用のELB提供 <ul>
        <li>
          Slaveが増やせても複数台それぞれにアクセスするための仕組みはユーザで用意しなくては行けない
        </li>
        <li>
          アプリケーション側で工夫するとかDNSラウンドロビンにするとか。それを一元化するための仕組みは用意してあげたほうがいい
        </li>
      </ul>
    </li>
    
    <li>
      出来ればクエリを見てMaster/read replicaに振る <ul>
        <li>
          アプリケーションから見るとたった1つのホストにアクセスすればいい
        </li>
      </ul>
    </li>
  </ul>
  
  <p>
    上2つはそれほどハードルは高くないと思うので、多分もうAmazonは準備していると思うけど、あとはいつ出てくるかだけかな。
  </p>
</div>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-02-07T00:00:00+09:00" pubdate data-updated="true">Feb 7<span>th</span>, 2011</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/tech/'>Tech</a>

</div>


	
		<span class="comments"><a href="/2011/02/06/amazon-rds-read-replica/#disqus_thread">Comments</a></span>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner"><br>
<div class="row">
	<div class="col-sm-2 col-sm-offset-3 text-center">
		<img src="/images/hirofukami.jpg" alt="Hiro Fukami" class="img-circle">
	</div>
	<div class="col-sm-4 text-left text-muted">
		<h3>Hiro Fukami</h3>
		<a href="http://twitter.com/d_sea">@d_sea</a>. Business Starter and Engineer in Tokyo.
		Founder and CEO of <a href="http://www.shakesoul.net">ShakeSoul, inc.</a>. See more about me <a href="/about">here</a>.
	</div>
</div>

<br>

Copyright &copy; 2015

    HiroFukami

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<!-- <script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> --> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'hirofukamisblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-44359867-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
