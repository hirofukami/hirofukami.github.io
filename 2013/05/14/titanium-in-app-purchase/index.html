
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>Titanium で In App Purchase する手順(StoreKit)  | Hiro Fukami's Blog</title>

<meta name="author" content="HiroFukami"> 

<meta name="description" content="いつでも前のめり"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hiro Fukami's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Hiro Fukami's Blog</a></h1>
<h4>My Life Log on Octopress</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:hirofukami.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Titanium で in App Purchase する手順(StoreKit)</h2>
	<div class="entry-content"><p>Apple の審査も <a href="https://itunes.apple.com/jp/app/dm-chat/id447521974" target="_blank">DmAtChat</a> と <a href="https://itunes.apple.com/jp/app/ftupdater-facebook-twitterniposutosurudakeno/id448808656?mt=8" target="_blank">FTupdater</a> 両方通ったことだし、Titanium Mobile 上で In-App Purchase を導入する手順をまとめておく。</p>

<p>基本的には4つの環境にまたがって実現する。</p>

<ol>
<li>iTunes Connect</li>
<li>コーディング、Titanium Studio</li>
<li>Xcode</li>
<li>iPhone実機</li>
</ol>


<p>参考にしたURL</p>

<ul>
<li><a href="http://kray.jp/blog/iphone-in-app-purchase/">http://kray.jp/blog/iphone-in-app-purchase/</a></li>
<li><a href="http://d.hatena.ne.jp/glass-_-onion/20111201/1322697417">http://d.hatena.ne.jp/glass-_-onion/20111201/1322697417</a></li>
</ul>


<p>前提</p>

<ul>
<li>すでに iTunes Connect 上でアプリが登録されていること</li>
<li>開発環境に Titanium Studio でプロジェクトが作成され、iPhone シミュレータが起動できること</li>
<li>開発環境に Xcodeがインストールされていること</li>
</ul>


<h2>iTunes Connect 上での作業</h2>

<h3>In-App Purchase の Product を作る</h3>

<ol>
<li>iTunes Connect へログイン、&#8221;Manage Your Apps&#8221; をクリック、In-App Purchase を導入したいAppをクリック</li>
<li>&#8220;Manage In-App Purchases&#8221; をクリック</li>
<li>&#8220;Create New&#8221; をクリック</li>
<li>Select Type にて選択する

<ul>
<li>消費する一時的なアイテムなら Consumable</li>
<li>ある機能を有効にするなら Non-Consumable</li>
<li>定期購読系なら各 Subscription : 審査基準が厳しいなどあるようでまだ試したことはない</li>
</ul>
</li>
<li>プロダクト情報を入力する

<ol>
<li>Reference Name : 内部管理用の表示名</li>
<li>Product ID : 内部管理用ID、他の App も含めてユニークにする必用があるので、&#8221;AppName_ProductName&#8221; みたいにするといいかも</li>
<li>価格を決める</li>
<li>Detail部分を入力する

<ol>
<li>Language : デフォルトだと英語。Display Name は App/App Sore 内で表示される名前なので、ユーザにわかりやすいものにする</li>
<li>Hosting Content with Apple : Apple の中にコンテンツを預けていなければ &#8220;No&#8221;。通常 No でいいはず</li>
<li>Screenshot for Review : Appleが審査するときのため用のスクリーンショットで App Store内には表示されない。何かしらアップロードしないと Status が変わらずプロダクト登録完了しないので、適当なものをあげておいて、動作確認後取ったスクリーンショットをAppサブミット前に変更する。</li>
</ol>
</li>
<li>&#8220;Save&#8221; をクリック</li>
</ol>
</li>
<li>In-App Purchases の一覧表にて、Status が Ready to Submit になったらOK</li>
<li>タイプが Auto-renew subscriptions の場合、一覧表の下にある View or generate shared secret のリンクを押す、キーをメモっておく</li>
</ol>


<h3>iTunes Connect テストユーザを作る</h3>

<ol>
<li>iTunes Connect のトップページに戻り、Manage Users > Test User > Add New User して作成する</li>
<li>クレジットカードの情報はいらない。入力するとテスト時に購入処理ができない。登録時に必須になっている場合は一度登録してあとで削除する

<ul>
<li>参考QA <a href="http://iphonedevsdk.com/forum/iphone-sdk-development/63008-in-app-purchase-test-account-verification-required-cant-get-passed.html">http://iphonedevsdk.com/forum/iphone-sdk-development/63008-in-app-purchase-test-account-verification-required-cant-get-passed.html</a></li>
</ul>
</li>
</ol>


<h2>StoreKit をプロジェクトに配置する</h2>

<ol>
<li>Appcelerator Marketplace で StoreKit module のページを開く

<ul>
<li><a href="https://marketplace.appcelerator.com/apps/794">https://marketplace.appcelerator.com/apps/794</a></li>
</ul>
</li>
<li>Download してPCローカルに保存された zip ファイルを解凍する</li>
<li>In App Purchase を適用したいプロジェクトのディレクトリに StoreKit module を配置する

<ul>
<li>iPhone用なのでパスは、ProjectName/modules/iphone/ti.storekit となる</li>
</ul>
</li>
<li>Titanium Studio にて該当のプロジェクトの tiapp.xml ファイルにて確認する

<ul>
<li>Modules の一覧表に &#8220;ti.sorekit&#8221; が確認出来ればOK</li>
<li>XMLファイルのソース的には <modules>タブの中に以下の様な記述があればOK
<pre>&lt;module platform=&ldquo;iphone&rdquo; version=&ldquo;1.6.4&rdquo;&gt;ti.storekit&lt;/module&gt;</pre></li>
</ul>
</li>
</ol>


<h2>コードを書く</h2>

<!--more-->


<p>example の app.js を読んで、記述の仕方を把握する</p>

<ul>
<li>ProjectName/modules/iphone/ti.storekit/versionNo/example/app.js</li>
<li>基本的にはここに書かれている処理を理解すれば流用可能</li>
</ul>


<p>基本的な機能</p>

<p>購入情報は iPhone のローカルメモリと iTunes Connect に保存されるが、ローカルメモリ上に情報がない場合(購入済みなのに購入していないことになっている)ことを復旧させるためにリストア(iTunes Connect の購入履歴をローカルメモリへコピーする)処理がある。</p>

<ul>
<li>Storekit.canMakePayments : 購入可能状態かどうか、true/false で返る</li>
<li>Storekit.requestProducts(product) : iTunes Connect で作成した In App Purchase プロダクト(product)の情報を得る</li>
<li>Storekit.purchase(product) : product を購入する</li>
<li>Storekit.restoreCompletedTransactions() : すでに購入済みのプロダクトがローカルにない時にリストアする</li>
</ul>


<p>最初に記述する部分</p>

<pre class="brush: jscript; title: ; notranslate" title="">var Storekit = require('ti.storekit');

Storekit.receiptVerificationSandbox = true;
</pre>


<p>In App Purchase のタイプが Auto-renew subscriptions の場合、receiptVerificationSharedSecret の記述をする。メモっておいた Shared Secret のキーを記述する。</p>

<pre class="brush: jscript; title: ; notranslate" title="">Storekit.receiptVerificationSharedSecret = "&lt;YOUR STOREKIT SHARED SECRET HERE&gt;";
</pre>


<p>Expample app.js 上で function にして記述してあるので、そのまま流用しやすくなっている。</p>

<pre class="brush: jscript; title: ; notranslate" title="">function requestProduct(identifier, success)
{
    showLoading();
    Storekit.requestProducts([identifier], function (evt) {
        hideLoading();
        if (!evt.success) {
            alert('ERROR: We failed to talk to Apple!');
        }
        else if (evt.invalid) {
            alert('ERROR: We requested an invalid product!');
        }
        else {
            success(evt.products[0]);
        }
    });
}
</pre>


<p>購入処理のイベントが拾えて購入済、購入処理、リストア処理、Fail ごとに処理も書かれているので、これもそのまま流用できる。</p>

<pre class="brush: jscript; title: ; notranslate" title="">Storekit.addEventListener('transactionState', function (evt) {
    hideLoading();
    switch (evt.state) {
        case Storekit.FAILED:
            if (evt.cancelled) {
                alert('Purchase cancelled');
            } else {
                alert('ERROR: Buying failed! ' + evt.message);
            }
            break;
        case Storekit.PURCHASED:
            if (verifyingReceipts) {
                Storekit.verifyReceipt(evt, function (e) {
                    if (e.success) {
                        if (e.valid) {
                            alert('Thanks! Receipt Verified');
                            markProductAsPurchased(evt.productIdentifier);
                        } else {
                            alert('Sorry. Receipt is invalid');
                        }
                    } else {
                        alert(e.message);
                    }
                });
            } else {
                alert('Thanks!');
                markProductAsPurchased(evt.productIdentifier);
            }
            break;
        case Storekit.PURCHASING:
            Ti.API.info("Purchasing " + evt.productIdentifier);
            break;
        case Storekit.RESTORED:
            // The complete list of restored products is sent with the `restoredCompletedTransactions` event
            Ti.API.info("Restored " + evt.productIdentifier);
            break;
    }
});
</pre>


<h2>テスト</h2>

<p>Titanium Studio 上から iPhone シミュレーターを起動するとテストの購入処理ができないようで、Xcode から実機で起動してのテスト方法が Example app.js の中で書いてある。</p>

<blockquote><p>1) Storekit works in two different environments: &#8220;Live&#8221; and &#8220;Sandbox&#8221;. It automatically uses the &#8220;Sandbox&#8221; when you run your app in Xcode. This means that &#8220;Deploy to Device&#8221; in Titanium Studio will connect to the &#8220;Live&#8221; environment! Using a test account in &#8220;Live&#8221; will ruin the test account. And paying for items with a live account will quickly suck up your hard earned cash. So be careful!</p></blockquote>

<ol>
<li>テストを実行する実機の iPhone 上で Settings > iTunes &amp; App Stores でログアウトしておく</li>
<li>1回、該当のプロジェクトを Titanium Studio から iPhone シミュレーターで起動して、落とす</li>
<li>プロジェクト内にある、ProjectName/build/iphone/ProjectName.xcodeproj を開く</li>
<li>Xcode が起動する</li>
<li>実機の iPhone をつないで、&#8221;Scheme&#8221; でその実機を選ぶ</li>
<li>&#8220;Run&#8221; ボタンを押して、実機からアプリが起動して購入処理をテストする</li>
<li>iTunes Connect で作成したテストユーザの情報でログインする</li>
<li>購入が出来ればOK</li>
</ol>


<p><a href="images/2013/05/ios-simulator-screen-shot-2013-04-09-10-35-29.png"><img class="size-medium wp-image-919 alignnone" alt="iOS Simulator Screen shot 2013.04.09 10.35.29" src="/images/2013/05/ios-simulator-screen-shot-2013-04-09-10-35-29.png?resize=169%2C300" data-recalc-dims="1" /></a><a href="images/2013/05/img_2464.png">  <img class="size-medium wp-image-920 alignnone" alt="IMG_2464" src="/images/2013/05/img_2464.png?resize=169%2C300" data-recalc-dims="1" /></a>  <a href="images/2013/05/img_2465.png"><img class="size-medium wp-image-921 alignnone" alt="IMG_2465" src="/images/2013/05/img_2465.png?resize=169%2C300" data-recalc-dims="1" /></a></p>

<h2></h2>

<h2>Apple にサブミットして審査を受ける</h2>

<p>iTunes Connect の Manage Your Apps にて新しいバージョンのアプリを作る。その際に In App Purchase を適用することを忘れずに。</p>

<p>UI上 Restore のボタンを用意するには必須。処理上で書いていてもUI上にリストアボタンがないと Apple が審査時にリジェクトする。</p>

<h1>#</h1>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-05-15T01:00:19+09:00" pubdate data-updated="true">May 15<span>th</span>, 2013</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/tech/'>Tech</a>

</div>


	
		<span class="comments"><a href="/2013/05/14/titanium-in-app-purchase/#disqus_thread">Comments</a></span>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    HiroFukami

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'hirofukamisblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-44359867-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
