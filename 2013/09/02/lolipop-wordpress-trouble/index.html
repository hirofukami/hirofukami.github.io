
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>ロリポップ WordPress 大規模改ざんの原因予想と思ふところ  | Hiro Fukami's Blog</title>

<meta name="author" content="HiroFukami"> 

<meta name="description" content="「ロリポップ」でWordPress利用サイトが改ざん　「大規模攻撃」で被害4802件 現時点では、まだ完全に収束していなくて、ロリポップはこの件のアップデートをお知らせし続けている。 この原因は「WordPressのテーマかプラグインの脆弱性からファイルパーミッションの設定不備をつかれた」 &hellip;"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hiro Fukami's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/favicon.png" rel="shortcut icon">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
	<meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="d_sea">
    <meta property="twitter:url" content="http://hirofukami.com">
    <meta property="twitter:title" content="ロリポップ WordPress 大規模改ざんの原因予想と思ふところ">
    <meta property="twitter:description" content="「ロリポップ」でWordPress利用サイトが改ざん　「大規模攻撃」で被害4802件 現時点では、まだ完全に収束していなくて、ロリポップはこの件のアップデートをお知らせし続けている。 この原因は「WordPressのテーマかプラグインの脆弱性からファイルパーミッションの設定不備をつかれた」とのことだけど、これだけでは不明確で、追々報告はあるかもしれないが、いまだ全容は明らかになっていない。
「 &hellip;">
    <meta property="twitter:creator" content="d_sea" />


</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Hiro Fukami's Blog</a></h1>
<h4>My Life Log on Octopress</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
    
	<li>
        <form action="http://google.com/search" method="get">
            <input type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="as_sitesearch" value="hirofukami.com">
        </form>
	</li>
    
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
	<li><a href="/atom.xml">RSS</a></li>
    
	<li>
        <form action="http://google.com/search" method="get">
            <input type="text" name="q" results="0" placeholder="Search">
            <input type="hidden" name="as_sitesearch" value="hirofukami.com">
        </form>
	</li>
    
</ul>
</div>
	</div>
<!-- 	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:hirofukami.com">
			</form>
		</div>
	</div> -->
</nav>

</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">ロリポップ WordPress 大規模改ざんの原因予想と思ふところ</h2>
	<div class="entry-content"><p><a href="http://www.itmedia.co.jp/news/articles/1308/29/news093.html" target="_blank">「ロリポップ」でWordPress利用サイトが改ざん　「大規模攻撃」で被害4802件</a></p>

<p>現時点では、まだ完全に収束していなくて、ロリポップはこの件の<a href="http://lolipop.jp/info/news/4149/" target="_blank">アップデートをお知らせし続けている</a>。</p>

<p>この原因は「WordPressのテーマかプラグインの脆弱性からファイルパーミッションの設定不備をつかれた」とのことだけど、これだけでは不明確で、追々報告はあるかもしれないが、いまだ全容は明らかになっていない。<br/>
<a href="http://www.itmedia.co.jp/news/articles/1308/30/news127.html" target="_blank">「ロリポップ」のWordPressサイト改ざん被害、原因はパーミッション設定不備</a></p>

<p>という状況なのだけど、WordPress 制作者の皆さんは何が起きてどうすればいいのか、イマイチ理解されていない気がして、リアクションできずに固まって、エンドユーザへの説明もなかなかつらいところなのではと思う。</p>

<p>もう少し現象が分かるように、予想もあるけども追ってみたいと思う。今後共有レンタルサーバを提案して良いものなのかどうか、みなさんのお仕事の参考なれば良いと思う。</p>

<h2>予想される流れ</h2>

<p>詳細が公表されていないので、具体的にはなんとも言えないけど、ロリポップの公表情報から予測してみると以下の流れがあるのではと思う。</p>

<ol>
<li>あるユーザが自分の WordPress サイトに悪意のある非公式なテーマ or プラグインをサーバにおいた</li>
<li>そのテーマ or プラグインがサーバ内で動作する</li>
<li>そのサーバに共有されている他ユーザのディレクトリ名が分かる</li>
<li>Apache の mod_rewrite 上のオプション FollowSymLinks が有効になっていたので、他ユーザの wp-config.php へのパスを予測してシンボリックリンクを貼って http 経由でアクセスして wp-config.php の内容を見る</li>
<li>サーバ内 or 外部から DB サーバへアクセスし、テーブルの内容を書き換える</li>
<li>4,5 の繰り返し</li>
</ol>


<h2>現象の原因要素</h2>

<p>この流れが成立するためにはいくつかの要素必要。</p>

<ol>
<li>ロリポップのパーミッション設定不備</li>
<li>共有サーバという形態</li>
<li>WordPress の決められたファイルパスと情報</li>
</ol>


<p>この3つがそれぞれ成立したことで現象は生じた。</p>

<h2>ロリポップのパーミション設定不備</h2>

<p>対応内容で FollowSymLinks から SymLinksIfOwnerMatch に変えたとあったので、これで他ユーザの wp-config.php の内容を盗めたのではと思う。お互いのユーザのディレクトリ内は見えないようになっている状態だったが、そこをシンボリックリンクで http で飛び越えてしまう。<br/>
詳細はわからないが、サーバ内部ではシンボリックリンクを <em>/[他ユーザディレクトリ名]/wp-config.php</em> あてに貼りまくって、http アクセスして中身を見るということかな？と思っている。</p>

<p>技術的に実証して くださっている方がいた : <a href="http://blog.tokumaru.org/2013/09/symlink-attack.html" target="_blank">ロリポップのサイト改ざん事件に学ぶシンボリックリンク攻撃の脅威と対策</a><br/>
そもそもこの設定不備がなければ事象は起きなかったと思う。</p>

<h2>共有サーバという形態</h2>

<p>共有サーバは ssh login してみるとわかるけど、同居している他ユーザのディレクトリ名が分かってしまう。<br/>
ssh login して <em>$ ls -l ../</em> すれば見えるはず。これは共有サーバであればどこもできるはず。致し方ない部分。</p>

<p>サーバは共有なのだけど Web サーバは各ユーザそれぞれ独立して動かすことができるように Web サーバには suEXEC が設定されている。<br/>
また、他ユーザのディレクトリ配下のファイルが見えたり Web アプリからアクセスできてしまうとまずいので、全ユーザを1つのグループに入れてグループパーミッションを与えないようにすれば成立できる。だから今回で言うとパーミッションは 404 とか 400 にしましょうと2桁目が0にするようにサーバ運用会社は推奨している。これはセキュアにするための運用上の理由。</p>

<p>おそらく今回改ざんされちゃった人の wp-config.php のファイルパーミッションはグループ(2桁目)が Read(4) 以上のアクセスを付与してあったのだろう。それが結構な人数いたからこれだけの被害の大きさになったと思う。<br/>
結構パーミッションは見落としがちで、自分のローカルPC上で wp-config.php を編集して DB 情報を記入して保存。この時点でパーミションは 644 とか になってしまって、グループに Read が与えられてしまい、そのまま気づくことなく FTP でサーバにアップロードしてしまう。</p>

<p>サーバ内においてはユーザのディレクトリのパーミッションはグループは 0 に設定されているので、たとえその下部にある wp-config.php のグループパーミッションに Read が付いていたとしても覗けないのだが、おそらく FollowSymLinks を使って、シンボリックリンクごしに http 経由でファイルにアクセスできたのではと思う。</p>

<h2>WordPress の決められたファイルパスと情報</h2>

<p>WordPress は接続する DB の情報を wp-config.php に書く。そしてこの wp-config.php ファイルは Web で公開するディレクトリの最上部の階層に設置するケースがほどんどだろう。<br/>
wp-config.php に DB の情報を書くことは WordPress 上の決まりなので、しょうがないところではある。<br/>
そして、この決まりは知れ渡っているので狙われやすい状況ではある。</p>

<p>DB の情報を抜き出せればあとは、その情報を使って DB にログインして DB 内のデータを update する。ちょっと気になるのがこれは共有サーバからアクセスしたのではなくインターネット外部からなのでは？というところ。今回サーバ上のファイルはそのままだったようなのでサーバにログインしないで実行している気がする。DB に対するファイアウォールが内部の Web サーバからだけに絞られていないで、インターネット上にさらした状態であったとすれば、これもサーバ運用会社の不備ということになる。</p>

<h2>まとめると</h2>

<p>サマリー的に言うと、</p>

<ul>
<li>同一サーバ上の他ユーザのディレクトリ名一覧が入手できるという、共有サーバのセキュリティ上のリスクと</li>
<li>WordPress の wp-config.php という特定のファイル名と重要な情報を持っていることが知れ渡っていること。</li>
<li>というセキュリティリスクの高い状況下で、</li>
<li>FollowSymLinks の設定不備が引き金になって起こった。</li>
</ul>


<p>というところだろう。</p>

<h2>そして、もう時代はクラウドへの移行なのではないか？</h2>

<p>共有サーバのサービスはもう10年以上提供されていて、使われている技術は変わらず当時の古い、いわゆる枯れた技術で運用され続けている。クラウド登場前、Web1.0時代のホスティング手段で、物理サーバしかない時に安くホスティングサービスを提供するかという視点で作られている。</p>

<p>セキュリティを考えるなら1サーバに複数ユーザではなく、1サーバ1ユーザの形態で他ユーザの影響が自分に及ばない環境を求めるべきで、今なら低いスペックのVPSや1OS上でコンテナでより独立した環境を提供できる。より新しい技術やツールは出てきているのが現状。</p>

<p>いい加減古い技術から離れたほうがいいのでは、というのが私の意見。古いものは必ずセキュリティリスクが高くなっていく。おそらく今回の事象で FollowSymLinks は無効化しても、.htaccess 内に書いたら？とかそれをさせないためにサーバ運用会社はガイドラインを示すだろうけど、他社も含めリスクの指摘はあったが、今頃あたふたというのはちょっとまずいだろう。個人利用ならまだしも、ビジネスで使うレベルではないと思っている。</p>

<p>今回の事象は古いサービスを使い続けることからクラウドへ移行することを促す一つの警鐘と捉えてもいいと思う。</p>

<p>おそらく共有サーバを今でも選定される理由は、安さ、サーバ知識のいらない環境(ワンクリックインストールやWeb UIからの操作など)からだ思うが、クラウドの専用サーバ環境で同じような使い勝手を PaaS/SaaS として提供することは十分可能。日本では VPS の宣伝が大きくて、その上のレイヤまでカバーしてサーバレイヤを抽象化するようなサービスが少ないので、共有サーバに流れてしまっていると思う。</p>

<p>私がカバーしたいと思っているのはまさにこのサーバを意識しない抽象化されたクラウドサービスになる。しかも、これを簡単に提供すること。今クローズドβリリース準備中の <a href="http://www.shakesoul.net/smartwordpress" target="_blank">スマートWordPress</a> は、そんなサーバを意識しない抽象化した WordPress レイヤを簡単に提供するクラウドサービスです。<br/>
クラウドのメリットを十分に活かして「必要な分を、必要な時に」動かして安心してサイト運営できるようにしている。確かに、共有サーバの500円〜2000円のレンジに比べれば高額になる予定だが、より本格的なサイト運営を求める方々の良きツールになりたいと思っている。</p>

<p>興味のある方は <a href="http://www.shakesoul.net/smartwordpress" target="_blank">スマートWordPress</a> のページでメール登録をお願いします。クローズドβリリースのご案内をさせていただきます。</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-09-02T23:49:48+09:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2013</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/business/'>Business</a>

</div>


	
		<span class="comments"><a href="/2013/09/02/lolipop-wordpress-trouble/#disqus_thread">Comments</a></span>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner"><br>
<div class="row">
	<div class="col-sm-2 col-sm-offset-3 text-center">
		<img src="https://graph.facebook.com/1282639350/picture?width=119" alt="Hiro Fukami" class="img-circle">
	</div>
	<div class="col-sm-4 text-left text-muted">
		<h3>Hiro Fukami</h3>
		<a href="http://twitter.com/d_sea">@d_sea</a>. Business Starter and Engineer in Tokyo.
		Founder and CEO of <a href="http://www.shakesoul.net">ShakeSoul, inc.</a>. See more about me <a href="/about">here</a>.
	</div>
</div>

<br>

Copyright &copy; 2015

    HiroFukami

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'hirofukamisblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-44359867-3']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
