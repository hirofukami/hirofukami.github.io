<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Tech | Hiro Fukami's Blog]]></title>
  <link href="http://hirofukami.com/blog/categories/tech/atom.xml" rel="self"/>
  <link href="http://hirofukami.com/"/>
  <updated>2015-03-26T11:24:51+09:00</updated>
  <id>http://hirofukami.com/</id>
  <author>
    <name><![CDATA[HiroFukami]]></name>
    <email><![CDATA[dee.sea@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Mac - boot2docker 1.4.1 間共有フォルダ設定方法]]></title>
    <link href="http://hirofukami.com/blog/2015/02/09/mac-docker-sharedfolder/"/>
    <updated>2015-02-09T19:00:00+09:00</updated>
    <id>http://hirofukami.com/blog/2015/02/09/mac-docker-sharedfolder</id>
    <content type="html"><![CDATA[<p>{% img /images/2015/02/20150209-docker.png &lsquo;docker&rsquo; %}</p>

<p>Mac で <a href="https://www.docker.com/">Docker</a> を動かそうとすると <a href="http://boot2docker.io/">boot2docker</a> は必須。</p>

<p>Vagrant みたいに開発環境用サーバとして Docker を扱うには、共有フォルダの設定を自分でやらなくてはならない。</p>

<p>自分的には Dockerfile も Mac のローカルフォルダで管理したいから、Mac &ndash; boot2docker 間で共有フォルダを設定して、</p>

<ol>
<li>Mac 上で Dockerfile を作る</li>
<li>boot2docker ssh</li>
<li>docker build -t centos:rails</li>
</ol>


<p>みたいにやりたい。</p>

<p>もちろん、Dcoker container に Mac でコーディングしたソースは自動的にデプロイしたいので、boot2docker &ndash; docker container 間も共有フォルダにする必要はあるのだけど、まずは Mac &ndash; boot2docker 間を共有したい。</p>

<p>調べてみたが検索に引っかかるのは古い情報で、Github の README.md に記載を見つけて動いた。</p>

<p>2015.02.09現在 boot2docker 1.4.1 で動かすための方法をメモしておく。</p>

<h1>情報のソース</h1>

<p><a href="https://github.com/boot2docker/boot2docker">boot2docker の github</a> の README.md 内の <strong>VirtualBox Guest Additions</strong></p>

<p><a href="https://github.com/boot2docker/boot2docker#virtualbox-guest-additions">https://github.com/boot2docker/boot2docker#virtualbox-guest-additions</a></p>

<blockquote><p>The first of the following share names that exists (if any) will be automatically mounted at the location specified:</p>

<ol>
<li>Users share at /Users</li>
<li>/Users share at /Users</li>
<li>c/Users share at /c/Users</li>
<li>/c/Users share at /c/Users</li>
<li>c:/Users share at /c/Users</li>
</ol>
</blockquote>

<p>という記述がある。</p>

<!-- more -->


<h1>古い boot2docker が入っている人</h1>

<p>実行前には、<code>$ boot2docker stop</code> して boot2docker VM を停止しておく。</p>

<p>boo2docker のアップグレードをします。Mac のターミナル上で、</p>

<p><code>$ boot2docker upgrade</code></p>

<p>を実行。</p>

<p>すると、新しい iso ファイルが、<code>$HOME/.boot2docker/boot2docker.iso</code>(自分の場合は、<code>/Users/hironobu/.boot2docker/boot2docker.iso</code>) にダウンロードされます。</p>

<p>確認したければ、<code>$ boot2docker up &amp;&amp; boot2docker ssh</code> してログインプロンプトに <code>Boot2Docker version 1.4.1</code> が見えればOK。</p>

<h1>VirtualBox コマンドで共有する</h1>

<p>VirtualBox の Share Name を <code>Users</code> にすればうまくマウントしてくれそう。以下を Mac のターミナル上で実行する。</p>

<p><code>
$ VBoxManage sharedfolder add boot2docker-vm --name Users --hostpath $HOME
</code></p>

<p><code>boot2docker-vm</code> は VirtualBox 上の boot2docker の VM 名。
<code>$HOME</code> は自分の場合、 <code>/Users/hironobu</code> になる。</p>

<p>VirtualBox 上の設定画面は以下のようになった。</p>

<p>{% img /images/2015/02/20150209-ScreenShot.png &lsquo;VirualBox screen shot %}</p>

<p>古い情報だと Share Name を <code>home</code> にすると書いてあるブログもあったが、やってみたが認識しなかった。</p>

<h1>確認</h1>

<p>```bash
$ boot2docker up</p>

<p>$ boot2docker ssh</p>

<pre><code>                    ##        .
              ## ## ##       ==
           ## ## ## ##      ===
       /""""""""""""""""\___/ ===
  ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
       \______ o          __/
         \    \        __/
          \____\______/
</code></pre>

<hr />

<p>| |<strong>   </strong><em>   </em><strong> | |<em>|</em></strong> \ <strong>| | </strong><em>   </em><strong>| | </strong><em><strong> _ </strong>
| &lsquo;</em> \ / _ \ / _ \| <strong>| </strong>) / <em>` |/ _ \ / <strong>| |/ / _ \ &rsquo;</strong>|
| |</em>) | (<em>) | (</em>) | |<em> / __/ (</em>| | (<em>) | (<strong>|   &lt;  </strong>/ |
|</em>.<strong>/ _</strong>/ _<strong>/ _<em>|</em></strong><strong>_<em>,</em>|_</strong>/ _<strong>|_|__</strong>|_|
Boot2Docker version 1.4.1, build master : 86f7ec8 &ndash; Tue Dec 16 23:11:29 UTC 2014
Docker version 1.4.1, build 5bc2ff8</p>

<p>docker@boot2docker:~$ ll /
total 4
drwxr-xr-x    1 docker   staff         3332 Jan 27 23:34 Users/</p>

<p>(snip)</p>

<p>docker@boot2docker:~$ ll /Users/</p>

<p>(snip)
```</p>

<p><code>/Users</code> が boot2docker 内に見えて、<code>/Users</code> 内を見ると Mac の $HOME(自分の場合は、<code>/Users/hironobu</code>)が見えるはず。</p>

<p>ということでした (・ω&lt;)</p>

<p>快適な docker 開発ライフを〜</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker Meetup Tokyo #2 に参加した]]></title>
    <link href="http://hirofukami.com/blog/2014/04/11/docker-meetup-tokyo2/"/>
    <updated>2014-04-11T22:00:00+09:00</updated>
    <id>http://hirofukami.com/blog/2014/04/11/docker-meetup-tokyo2</id>
    <content type="html"><![CDATA[<p><img src="https://connpass-tokyo.s3.amazonaws.com/thumbs/7f/d1/7fd16d32367bb52155ca416e032071fc.png" alt="Docker Meetup Tokyo #2" /></p>

<ul>
<li>イベント概要 : <a href="http://connpass.com/event/5640/">http://connpass.com/event/5640/</a></li>
<li>togetter : <a href="http://togetter.com/li/653977">http://togetter.com/li/653977</a></li>
</ul>


<p>最近 Docker Docker と tweet されていて、かなりな盛り上がりを見せている Docker ですが、その Meetup があるらしいと tweet で流れていたので申込んだら80番目くらいで申し込めたので行ってきました。</p>

<p>最終的には100名定員に400名以上が申し込んでとんでもないブームになっていました。
多分、自分と同じように触れてないけど Docker ってどんなふうに使っているの？みたいに把握しておきたい人たちが殺到したのでは？と思うところです。</p>

<p>以下、メモと思ったことのまとめです。</p>

<!-- more -->


<h2>前半発表内容</h2>

<h3>@mainyaa：今からでも間に合うDocker基礎+Docker 0.9概要+Docker 0.10概要</h3>

<iframe src="http://www.slideshare.net/slideshow/embed_code/33405582" width="597" height="486" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/mainya/dockerdocker09-010" title="Docker基礎+docker0.9, 0.10概要" target="_blank">Docker基礎+docker0.9, 0.10概要</a> </strong> from <strong><a href="http://www.slideshare.net/mainya" target="_blank">Kazuyuki Mori</a></strong> </div>


<p><a href="http://www.slideshare.net/mainya/dockerdocker09-010">http://www.slideshare.net/mainya/dockerdocker09-010</a></p>

<p>Docker の概要を基本からおさらいしてくれる良いスライドでした。</p>

<p>今後本格的に触るかどうか判断しておきたい自分にとっては、概要を理解しつつ最新状況も把握できたとてもありがたい情報ばかりでした。</p>

<ul>
<li>デモ

<ul>
<li>Dockerfile に書いてビルドして、追記して</li>
<li>ビルド、前回実行部分はキャッシュ、新しい部分だけ新たに実行</li>
<li>差分だけ実行</li>
</ul>
</li>
<li>Docker前提のCoreOSとか分散処理とかのOSが出てきている</li>
<li>Docker 0.9

<ul>
<li>LXC 必須ではなくなった、抽象化された、色々なOSでも動ける環境、開発中</li>
</ul>
</li>
</ul>


<h3>@ten_forward：Linuxカーネルのコンテナ関連機能入門</h3>

<script async class="speakerdeck-embed" data-id="7e257d80a38f013120051af8c79ec55f" data-ratio="1.41436464088398" src="//speakerdeck.com/assets/embed.js"></script>


<p><a href="https://speakerdeck.com/tenforward/linux-kernel-falsekontenaji-neng-2014-04-11">https://speakerdeck.com/tenforward/linux-kernel-falsekontenaji-neng-2014-04-11</a></p>

<ul>
<li>Docker そのものではなく、実現するベースとなっている LXC 中心の内容</li>
<li>Dockerに関しては最初の発表以上のものはなし</li>
<li>コンテナの歴史について、LXCの仕組み的な部分もあり</li>
</ul>


<h3>@naoya_ito：Dockerアプリケーションのポータビリティ</h3>

<script async class="speakerdeck-embed" data-id="37db7d10a3900131166e024e11a95d47" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>


<p><a href="https://speakerdeck.com/naoya/dockerapurikesiyonfalsepotabiriteiwokao-eru-number-dockerjp">https://speakerdeck.com/naoya/dockerapurikesiyonfalsepotabiriteiwokao-eru-number-dockerjp</a></p>

<ul>
<li><a href="http://kaizenplatform.in/">Kaizen Platform Inc.</a> の技術顧問の肩書になっていた

<ul>
<li># 最近資金調達したはず => やっぱりそうだった <a href="http://kaizenplatform.in/pressrelease/2014/03/31/series-a.html">http://kaizenplatform.in/pressrelease/2014/03/31/series-a.html</a></li>
</ul>
</li>
<li>Build Once, Run Anywhere どこでもDockerが動けば動かせるよ</li>
<li>atlassian/jira プロジェクト管理ツール

<ul>
<li>$ docker run atlassian/jira で社内で動いちゃう</li>
</ul>
</li>
<li><p>Heroku push のタイイングで LXC で作りなおしている、新しいのを作り古いの捨てる</p></li>
<li><p>ステートレスかつ Shared Nothing</p></li>
<li>実行/外部環境を明確化・抽象化する</li>
<li><p>使うアプリを管理するツールを使う</p>

<ul>
<li>その設計方式 The Twelve-Factor App</li>
<li>Dockerでどうやるか</li>
</ul>
</li>
<li><p>作ってみた</p>

<ul>
<li>git pull request に紐づくURLを発行して確認したい</li>
<li>デモ

<ul>
<li>sinatra で作ったWebアプリ</li>
<li>手順

<ul>
<li>ローカルにレポジトリを作る、git フックが入る</li>
<li>古いコンテナを落とす、新しい docker コマンドを立ち上げる</li>
<li>git push して master に上げる</li>
<li>他の人から見て git pull してURLがふられる</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<h2>聞き終わって</h2>

<h3>用途は開発過程でのお手軽サーバ環境</h3>

<p>まだプロダクションでは使わないようにと言われているけど、社内では結構ヘビーに使われている。</p>

<p>用途としては社内での開発、検証時に使いたいサーバ環境が多い印象。</p>

<p>差分管理という仕組みも良くて失敗したらロールバックできるし、<strong>試す</strong> という視点ではこの上ないお手軽環境。</p>

<h3>今までの仮想環境で最も手軽かつ高い汎用性</h3>

<p>カーネルが対応したサーバOSならば Docker 動くし、Dockerfile で手軽に環境を移動して別のサーバ上で動かすことができる。今までの仮想環境に比べてこれ以上ない手軽さと汎用性がある。</p>

<p>どんどん作って育てて、捨ててができる。Vagrant に代わって社内の開発環境とか検証環境に使われていくんだろうな。</p>

<p>今までオンプレミスの上でしか動かせなかった Vmware, Xen, VirtualBox(Vagrant) と
仮想サーバOS上の上にさらに仮想環境が作れる Docker。</p>

<p>この違いはとても大きい。ひとつの仮想環境のパラダイムシフトになるくらい大きなインパクトになる。</p>

<h3>Docker を使ったサービスできるんじゃん？</h3>

<p>Dockerfile さえあればそれを IaaS 上のサーバに置いて動かせるから、それを置いてあげる Docker(file) Hosting のようなことができる。PaaS ではなくて IaaS on IaaS みたな形態。手元で試したまんまがサーバ上で動かすことができるメリットがある。</p>

<p>ゆくゆく Docker 1.0 が出ればそれをそのままプロダクションとして動かしても良いから、開発環境(ローカル Dockerfile) = ステージング(Docker Hosting) = 本番(Docker Hosting) となってシームレスなデプロイが実現できる。</p>

<p>と思ったら既にいくつかのサービスが既にあった。</p>

<p><a href="http://www.centurylinklabs.com/top-10-startups-built-on-docker/">http://www.centurylinklabs.com/top-10-startups-built-on-docker/</a></p>

<p>サービスのプライシングを見るにどこも同じ感じ。通常のホスティングサーバみたいにCPU、メモリ、ディスク容量などのリソースによっていくつかの月額プランがある。
金額は $10/month 〜 $200/month の範囲。</p>

<p>技術的には新しいけど、プライシングのパラメーターが古いと結局現状のホスティング事業者の競争と同じように差別化しにくいから、サービス提供者側は価格を下げる叩き合いになっちゃう気がする。
もう少しユニークな視点で Docker の特徴とかをパラメータに入れられると良いかもね。</p>

<h3>Docker 1.0 が出た時のインパクトを考える</h3>

<p>既にこの盛り上がりようなので 1.0 が出て プロダクションとして使ってOKとなれば違った面が一気に活性化されそう。</p>

<p>でも、Docker Hosting は存在するし、サービス内で利用する用途としてはやっぱり現状の共有レンタルサーバの代わりとなるのが思いつきやすい。</p>

<p>現状の共有レンタルサーバの Apache1.0 suEXEC の環境はロリポ事件のようなことが起きてもそんなに改善はなくて、技術的な追求はないからだらだら過ごしてしまっている。</p>

<p>IaaS 1インスタンス 上にたくさんの Docker プロセスを立ち上げて、suEXEC に比べて独立性の高いセキュアな環境を提供できますよ。ということだろう。</p>

<p>あまり革新的なイメージはないけど、国内外のホスティングやさんたちはおそらくやる気がするから単なるWebホスティングサービスだけをすごくやろうとは思わない。</p>

<p>やるとしたら WordPress, Redmine とかアプリを入れて PaaS かな。でも現状共有型でも提供できてしまっているし、内部的にセキュアになるくらいか。</p>

<p>もう少し考えたいところ。</p>

<h3>今後も楽しみな Docker Meetup Tokyo</h3>

<p>今回で400名申込だったので、次回の #3 はどのくらいになってしまうんだろう。</p>

<p>ユーザも増えるだろうし、Docker 自身もすごいスピードでリリースされているので充実した内容になることが楽しみです。</p>

<p>スピーカーの皆様、企画いただいたオーガナイザーの方々へ感謝いたします。ありがとうございました！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chef solo knife コマンド覚書]]></title>
    <link href="http://hirofukami.com/2014/01/31/chef-solo-knife-command-memo/"/>
    <updated>2014-01-31T19:53:16+09:00</updated>
    <id>http://hirofukami.com/2014/01/31/chef-solo-knife-command-memo</id>
    <content type="html"><![CDATA[<p>{% img <a href="http://upload.wikimedia.org/wikipedia/en/5/56/Chef_Software_Inc._company_logo.png">http://upload.wikimedia.org/wikipedia/en/5/56/Chef_Software_Inc._company_logo.png</a> 380 %}</p>

<p>どうも Chef コマンドを覚えられず、入門 Chef solo を毎回読みなおしてしまっているので、コマンド覚書を作っておく。</p>

<ul>
<li>レポジトリ名 : chef-repo</li>
<li>chef クライアントホスト名 : chef-client</li>
<li>クックブック名 : cookbook-name</li>
</ul>


<p>適当に置き換えてください。</p>

<h1>新規</h1>

<h2>レポジトリ作成</h2>

<p>Chef レポジトリを作る。</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife solo init [chef-repo-name]</pre>


<h2>クックブック作成</h2>

<p>レシピを新規作成する。</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife cookbook create [cookbook-name] -o site-cookbooks</pre>


<h2>ノード設定</h2>

<p>chef クライアントに仕立てる。</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife solo prepare [chef-client-hostname]</pre>


<p>AWS EC2 に適用する場合はキーとユーザ名の指定が必要なので、ec2-user ユーザで作業すると、</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife solo prepare -i ~/Keypair/[key-file] ec2-user@[chef-client-hostname]</pre>


<p>とする。</p>

<p>nodesディレクトリに [chef-client-hostname].json が作成される。</p>

<h1>更新</h1>

<h2>レシピを編集する</h2>

<p>site-cookbooks/[cookbook-name]/recipes/default.rb を編集する。 適用したいレシピが複数に渡る場合はそれぞれの recipes/default.rb を編集する。</p>

<h2>適用したいnodeファイルを確認</h2>

<p>AWS EC2 AMI からの起動する際のように、すでに chef クライアントとして設定されているがホスト名が変わってしまう場合は、[chef-client-hostname].json ファイル名を割り当てられたホスト名に変更する。</p>

<p>適用したいクックブックが記述されているか、nodes/[chef-client-hostname].json ファイルの中身を確認。</p>

<h2>ノードに適用</h2>

<p>ノードに適用。</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife solo cook [chef-client-hostname]</pre>


<p>AWS EC2 に適用する場合はキーとユーザ名の指定が必要なので、ec2-user ユーザで作業すると、</p>

<pre class="brush: plain; title: ; notranslate" title="">$ knife solo cook -i ~/Keypair/[key-file] ec2-user@[chef-client-hostname]</pre>


<p>とする。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[スマートWP構築のChefレシピを公開します]]></title>
    <link href="http://hirofukami.com/2014/01/09/smartwp-setup-chef-recipe/"/>
    <updated>2014-01-09T20:52:32+09:00</updated>
    <id>http://hirofukami.com/2014/01/09/smartwp-setup-chef-recipe</id>
    <content type="html"><![CDATA[<p>去年夏に Chef に出会い、<a href="http://www.shakesoul.net/smartwp">スマートWP</a>のセットアップ方法を変えました。<br/>
<img src="http://docs.opscode.com/chef/_static/opscode_chef_html_logo.png?w=830" alt="" data-recalc-dims="1" /><br/>
今までは「AWS EC2 を手動でセットアップして AMI 保存」を繰り返すことでサーバをバージョンアップしてきた方法から、まっさらな AWS AMI を Chef で一気にセットアップするように切り替えました。</p>

<p>何が良いかというと、</p>

<ul>
<li>最新のバージョンが常に保たれる

<ul>
<li>AWS AMI もバージョンアップされるし、各アプリケーションも常にバージョンアップされるので</li>
<li>AMIを更新し続けると古いバージョンのままになってどこかでバージョンアップの作業が必要になる</li>
</ul>
</li>
<li>すべての作業内容がレシピに残る

<ul>
<li>どうしても手動だとやったことの記録漏れが出がち</li>
</ul>
</li>
<li>手動よりも圧倒的に早い</li>
</ul>


<p>というところかと思う。</p>

<p>そんな Cehf で作った<a href="http://www.shakesoul.net/smartwp">スマートWP</a>のレシピを公開します。</p>

<p>このレシピで作られたスマートWPのサーバ環境は私の個人ブログ <a href="http://hirofukami.com">hirofukami.com</a> と会社のサイト <a href="http://www.shakesoul.net">ShakeSoul inc.</a> があって、負荷状況に応じて自動的にサーバを増減させるオートスケーリングが動くようになっています。</p>

<p>ご興味のある方は <a href="http://www.shakesoul.net/smartwp">スマートWPのサービス紹介ページ</a>を見てみてください。</p>

<center>
  <br /> <a href="http://www.shakesoul.net/smartwp"><img src="http://www.shakesoul.net/wp-content/uploads/2013/05/SmartWP-Scale-h300.png?resize=327%2C180" class="alignnone" data-recalc-dims="1" /></a><br />
</center>




<!--more-->


<p>レシピは2つ使っていて、他の環境とも共用しているベースとなるセットアップの後にスケーラブルな構成のためのレシピを適用しています。</p>

<p>では、以下。私の <a href="https://gist.github.com/d-sea">Github Gist</a> からの貼付けです。</p>

<p>まずはベースの設定。recipe[swp_setup]です。</p>

<p>{% gist 8328203 swp_setup_default.rb %}</p>

<p>続いて、recipe[swap_scale-org]です。</p>

<p>{% gist 8328145 swp_scale-org_default.rb %}</p>

<p>これを nodes/[hostname].json で、</p>

<p>{% gist 8328241 node.json %}</p>

<p>のように書いて適用させています。</p>

<p>こんな感じで、Webサーバとしては nginx + php-fpm、それに Dropbox linux と s3fs を使っているのがお分かりかと思います。 今後、ここで読み込んでいるテンプレートの nginx のコンフィグとかなんかも公開しようかなと思っています。</p>

<p>色々やっている方とディスカッションしてみたいので、違うやり方しているよとかこっちのほうが良いよみたいなのがあればフィードバックください〜</p>

<p>あと、Chef 学びたいとかスケーラブルなサーバ環境つくりたいとかもあれば相談いただければです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[入門Chef 補完 &#8211; chef〜vagrant saharaインストール]]></title>
    <link href="http://hirofukami.com/2013/10/11/install-chef-solve-way/"/>
    <updated>2013-10-12T01:26:20+09:00</updated>
    <id>http://hirofukami.com/2013/10/11/install-chef-solve-way</id>
    <content type="html"><![CDATA[<p><img class="alignnone" alt="Chef Logo" src="http://docs.opscode.com/chef/_static/opscode_chef_html_logo.png?resize=200%2C154" data-recalc-dims="1" /></p>

<p>来ました Chef です。DevOps は考え方として把握していたけど、具体的にツールとして Chef が登場したし、<a href="http://www.shakesoul.net/smartwordpress" target="_blank">スマートWordPress</a> でも使えそうな気配がしたので、そろそろ把握するにはいタイミングだろうと思って学んでみている。</p>

<p>伊藤直也さん著の、今や Amazon でUnixオペレーティングシステムカテゴリベストセラーNo.1の入門Chef Solo を購入して読了。<br/>
<a href="http://www.amazon.co.jp/gp/product/B00BSPH158/ref=as_li_ss_il?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00BSPH158&amp;linkCode=as2&amp;tag=dsea-22"><img alt="" src="http://ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B00BSPH158&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=dsea-22" border="0" /></a><img style="border: none !important; margin: 0px !important;" alt="" src="http://ir-jp.amazon-adsystem.com/e/ir?t=dsea-22&l=as2&o=9&a=B00BSPH158" width="1" height="1" border="0" /><br/>
<a href="http://www.amazon.co.jp/gp/product/B00BSPH158/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00BSPH158&amp;linkCode=as2&amp;tag=dsea-22">入門Chef Solo &#8211; Infrastructure as Code</a><img style="border: none !important; margin: 0px !important;" alt="" src="http://ir-jp.amazon-adsystem.com/e/ir?t=dsea-22&l=as2&o=9&a=B00BSPH158" width="1" height="1" border="0" /></p>

<p>その通りに自分の環境づくりから始めたものの結構のっけからうまくいかないことが起こった。<br/>
先端的なものは変化が激しいしそんなこともあると思いつつ、色々調べつつ自分なりに起こった事象に対して解消していった。</p>

<p>そんな解消した方法を 入門Chef 補完として紹介します。</p>

<p>最初はChef インストールからローカルで 仮想環境操作を CLI 操作する vagrant のインストール、さらに vagrant のプラグイン sahara インストールまでのインストール手順になります。</p>

<p>今後、また検証が進んで補完内容がたまったら紹介します。</p>

<p>環境は</p>

<ul>
<li>OS X 10.7.5</li>
<li>Ruby 1.8.7</li>
<li>gem 1.3.7</li>
</ul>


<p>と、ちょっと古めの MacBook Air です。</p>

<!--more-->


<h2>Chef のインストール手順は Opscode のマニュアルに従う</h2>

<p>Chef のインストールは入門Chefでは gem install だが、古い gem だと入らない。gem をアップデートすればよいけど、そもそも ruby 1.9.2 より古いと動作しないかもということもあり、依存しているもののバージョンアップをいちいちするのは手間だし、追い切れない。</p>

<p>Chef のインストール方法は Opscode 提供のシェルを使うと Chef 含め必要なものを丸っとインストールしてくれる。動作確認されているであろう新しいバージョンが入る。<br/>
ここらへんの手順は入門Chefに頼らず一度 opscode.com のマニュアルを読んだ方が良い。</p>

<p><a href="http://docs.opscode.com/chef/install_workstation.html" target="_blank"><a href="http://docs.opscode.com/chef/install_workstation.html">http://docs.opscode.com/chef/install_workstation.html</a></a></p>

<p>手順は、以下を実行するだけ。</p>

<pre class="brush: bash; title: ; notranslate" title="">$ curl -L https://www.opscode.com/chef/install.sh | sudo bash
</pre>


<p>注意点は現状の環境と別で Mac だと /opt/chef というディレクトリが作られるので、環境に上書きされず Chef 用の独立した環境が1つ追加される。これを個人として許容できれば良いだろう。</p>

<p>作られる階層構造は以下、</p>

<pre class="brush: bash; title: ; notranslate" title="">/opt
   /chef
      /bin
      /embedded
         /bin
         /include
         /lib
         /share
         /ssl</pre>


<p>インストールが終わると、2つの異なる ruby バージョンが存在することになる。</p>

<pre class="brush: bash; title: ; notranslate" title=""># 今までの環境
$ ruby -v
ruby 1.8.7 (2012-10-12 patchlevel 371) [i686-darwin11]

$ which ruby
/opt/local/bin/ruby

$ gem -v
1.3.7

# インストールされた Chef 用の環境
$ /opt/chef/embedded/bin/ruby -v
ruby 1.9.3p448 (2013-06-27 revision 41675) [x86_64-darwin11.2.0]

$ /opt/chef/embedded/bin/gem -v
1.8.24
</pre>


<p>自分は現状の環境のバージョンがちょっと古いしその上で動かしていたものもあるので、独立して設けたほうが支障がなく簡単に導入できるのでこのやり方を使った。</p>

<h2>VirualBox, Vagrant, Sahara の失敗しないインストール方法</h2>

<p>本では、Vagran, Saharaまでのインストール手順は、</p>

<ol>
<li>VirtualBox インストール</li>
<li>gem install vagrant</li>
<li>OSメージダウンロード</li>
<li>vagrant gem install sahara</li>
</ol>


<p>だけど、この方法は自分の環境では動かなかったり、途中で不整合がでてインストールし直しが起きたりした。<br/>
結果的に手順は以下のようになった。</p>

<ol>
<li>Vagrant で使いたいOSイメージを決める</li>
<li>OSイメージのVirtualBox Guest Additions バージョンを確認</li>
<li>OSイメージの VirtualBox Guest Additions バージョンと同じ VirtualBox のバージョンをインストール</li>
<li>Vagrant のWebから最新バージョンのインストーラーをダウンロードしてインストール</li>
<li>vagrant plugin install sahara</li>
</ol>


<h3>VirtualBox のバージョンはゲストOSに依存している</h3>

<p>ゲストOSの VirtualBox Guest Additions と VirualBox のバージョンを一致させないと動かない。<br/>
vagrant up するとこんなエラーが出る</p>

<blockquote><p>[default] The guest additions on this VM do not match the install version of<br/>
VirtualBox! This may cause things such as forwarded ports, shared<br/>
folders, and more to not work properly. If any of those things fail on<br/>
this machine, please update the guest additions and repackage the<br/>
box.</p>

<p>Guest Additions Version: 4.2.16<br/>
VirtualBox Version: 4.2.18</p></blockquote>

<p>なので、最初にOSイメージを決めてそれに対応する VirtualBox のバージョンをインストールする必要がある。</p>

<p><a href="http://www.vagrantbox.es/" target="_blank"><a href="http://www.vagrantbox.es/">http://www.vagrantbox.es/</a></a> からだと、VirtualBox Guest Additions が示されていないイメージもあったり情報が不足しているが、自分はとりあえず情報がある<br/>
CentOS 6.4 x86_64 Minimal (VirtualBox Guest Additions 4.2.16, Chef 11.6.0, Puppet 3.2.3)<br/>
をダウンロードした。</p>

<p>VirtualBox Guest Additions 4.2.16 なので、VirualBox も 4.2.16 をインストールする。<br/>
<a href="https://www.virtualbox.org/wiki/Downloads" target="_blank"><a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></a> からだと最新版 4.2.18 しかないので、<br/>
<a href="https://www.virtualbox.org/wiki/Download_Old_Builds_4_2" target="_blank"><a href="https://www.virtualbox.org/wiki/Download_Old_Builds_4_2">https://www.virtualbox.org/wiki/Download_Old_Builds_4_2</a></a> から 4.2.16 を見つけてダウンロード、インストーラーでインストールする。</p>

<h3>Vagrant インストールは最新版インストーラーを使う</h3>

<p>入門Chefでは Vagrant のインストール方法は gem install でとあるが、gem を使うと古い Vagrant がインストールされて、Sahara などのプラグインが追加できなかった。<br/>
Opscode インストール方法で作られた Chef用 gem でも古い Vagrant だった。</p>

<pre class="brush: bash; title: ; notranslate" title="">$ /opt/chef/embedded/bin/gem search vagrant
 vagrant (1.0.7)</pre>


<p>このバージョンではプラグインを追加するコマンドがない。</p>

<p>解決方法は <a href="http://downloads.vagrantup.com/" target="_blank"><a href="http://downloads.vagrantup.com/">http://downloads.vagrantup.com/</a></a> より最新版をインストールする。OS X、Windows、Linuxなどプラットフォームごとにインストーラーが用意されている。<br/>
インストールが終わると sahara プラグインがインストールできる。</p>

<p>コマンドは vagrant gem install sahara ではなく(誤字？) vagrant plugin install sahara<br/>
参考になったURL : <a href="http://qiita.com/hnakamur/items/2c1ae50a23ddc9f7cbe8" target="_blank"><a href="http://qiita.com/hnakamur/items/2c1ae50a23ddc9f7cbe8">http://qiita.com/hnakamur/items/2c1ae50a23ddc9f7cbe8</a></a></p>

<pre class="brush: bash; title: ; notranslate" title="">$ vagrant -v
 Vagrant 1.3.4

# sahara プラグインインストール
 $ vagrant plugin install sahara

$ vagrant -h
 Usage: vagrant [-v] [-h] command []

-v, --version Print the version and exit.
 -h, --help Print this help.

Available subcommands:
 box
 destroy
 halt
 help
 init
 package
 plugin
 provision
 reload
 resume
 sandbox
 ssh
 ssh-config
 status
 suspend
 up</pre>


<p>vagrant sandbox コマンドが追加される。これで vagrant sandbox on とかが使えるようになる。</p>

<p>このやり方なら Chef インストールから vagrant が使えるところまで来れるはずです。</p>

<p>本を読んだけど、あれ？うまくいかないなぁとつまずいてしまった方の参考になれば幸いです。</p>
]]></content>
  </entry>
  
</feed>
